---
biblio-style: jabes
bibliography: lazbibreg.bib
documentclass: report
fontsize: 12pt
header-includes: \usepackage{mdwlist} \usepackage[compact]{titlesec} \usepackage{titling}
  \usepackage[font=small,labelfont=bf,tableposition=top]{caption} \usepackage{float}
  \floatstyle{plaintop} \restylefloat{table} \usepackage{lastpage} \usepackage{hyperref}
  \usepackage{colortbl} \usepackage{array} \hypersetup{backref,colorlinks=true} \usepackage{framed,color}
  \definecolor{shadecolor}{rgb}{0.95, 0.92, 0.88} \usepackage{graphicx} \usepackage{booktabs}
  \usepackage{fancyhdr} \usepackage[none]{hyphenat} \raggedright \usepackage{amsmath,
  amsthm, amssymb, bm} \usepackage{marginnote} \usepackage{subfig} \def\mygraphcaption{Here
  are my graphs.} \newlength{\mygraphwidth}\setlength{\mygraphwidth}{0.9\textwidth}
  \usepackage{listings}
output:
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    highlight: tango
  html_document:
    df_print: paged
subparagraph: yes
---
  \lstset{
	basicstyle=\small\ttfamily,
	columns=flexible,
	breaklines=true}
	
  \pagestyle{fancy}
  \fancyhead[L]{\textbf{Don, Mel, Madhumithra}}
  \fancyhead[C]{}
  \fancyhead[R]{\textbf{STAT 823 Project}}
  \fancyfoot[L]{}
  \fancyfoot[C]{}
  \fancyfoot[R]{Page -\thepage- of \pageref{LastPage}}
  \fancypagestyle{plain}{\pagestyle{fancy}}
  \renewcommand{\headrulewidth}{2pt}
  \renewcommand{\footrulewidth}{2pt}
 
 \hypersetup{
	colorlinks   = true,
	citecolor    = blue,
	linkcolor    = black,
	urlcolor     = blue
  }
  
  \begin{titlepage}
   \begin{center}
       \vspace*{2cm}
        
       \vspace{0.5cm}
 
       \textbf{\textit{\LARGE Studying factors associated with prostate-specific antigen (PSA) levels in prostate cancer patients }}
 
       \vspace{0.5cm}
      
       \textbf{\Large STAT 823: Spring Class Project, 2021} 
       
        \vspace{0.5cm}
        
         \textbf{\large Don Ghysels, Melanie Valdez, Madhumithra Subramanian Karthikes}
        
       \vfill
 
       \vspace{0.7cm}
 
       \includegraphics[width=0.4\textwidth]{figures/ku}
 
       \large Department of Biostatistics and Data Science \\
       University of Kansas, USA \\
       `r format(Sys.time(), '%B %e, %Y')`
 
   \end{center}
\end{titlepage}

```{r setup, include=FALSE}
# load packages
library(knitr)
library(formatR)
library(stargazer)
library(xtable)
library(readxl)
library(ggplot2)
library(ggcorrplot)
library(gridExtra)
library(leaps)
library(car)
library(readr)
library(faraway)
knitr::opts_chunk$set(echo = FALSE)
options(digits = 5, width = 60, xtable.comment = FALSE)#,knitr.table.format="latex")
opts_chunk$set(tidy.opts = list(width.cutoff=60), tidy=TRUE)
out_type <- knitr::opts_knit$get("rmarkdown.pandoc.to")
```

 \setlength{\headheight}{45pt}
 
\thispagestyle{empty}
\newpage
\pagenumbering{roman}
\setcounter{page}{1}
\pagestyle{plain}
\tableofcontents
\cleardoublepage
\phantomsection
\listoftables
\phantomsection
\listoffigures
\newpage
\pagenumbering{arabic}

\section{Abstract}
Put your abstract here

\newpage

\section{Introduction}
Put all your introduction about the study topic here and cite some references. For example,  The textbook ``\textbf{Design and Analysis of Experiments}'' by \citet{voss} is required. Additional materials that you may wish to consult include \citet{casella}, \citet{kuehl} and \citet{shalabh}.

\subsection{Primary Analysis Objectives}

Determine the association between \textit{ Serum Prostate-specific antigen level (mg/ml) \textbf{(PSA)}} and other clinical measurements in men with advanced prostate cancer

\subsection{Secondary Analysis Objectives}

Summarize patient demographic and baseline clinical characteristics

Patients experiencing end-stage renal disease (ESRD) often require a kidney transplant as it prolongs survival, decreases morbidity, and improves quality of life.  Given that over 100,000 patients are awaiting kidney transplantation, it is desirable to find ways for patients to decrease their waiting time in hopes of obtaining a transplant sooner.  A growing number of patients with ESRD have developed antibodies against human leukocyte antigens (HLAs), limiting their options for finding a reliable matching donor.  Having a treatment that reduces HLAs could have a profound impact for patients experiencing ESRD.  Study ABCD is an open-label trial exploratory study investigating the effect of compound XYZ in patients with ESRD and calculated panel reactive antibodies (cPRAs) greater than 50 percent.  

\section{Materials and Methods}
\subsection{Data Sources}
The dataset was obtained from the stat823 project materials. The data set was selected due to the teams interest in exploring a science related topic as well as the interesting data distributions.

The data set includes 8 data variables.  The response vararible of interest is \textbf{Serum prostate-specific antigen level} and 7 clinical measures which inclue \textbf{Estimate of prostate cancer volume}, \textbf{Prostate weight}, \textbf{Age of patient}, \textbf{Amount of benign prostatic hyperplasia}, \textbf{Degree of capsular penetration}, \textbf{Seminal Vesical Invasion}, and the \textbf{Cleason Score}.

\begin{table}
\caption{Potential Model Covariates}
\centering
\begin{tabular}{c c c c}
\hline
Variable & Units & Abbreviation & Type \\ [0.5ex] % inserts table
%heading
\hline
Serum prostate-specific antigen level & mg/ml & PSA & \textbf{Response} \\ % inserting body of the table
Estimate of prostate cancer volume & $cm^{3}$ & VOL & Continuous \\ 
Prostate weight  & gm & WT & Continuous \\
Age of patient & Years & AGE & Continuous \\
Amount of benign prostatic hyperplasia & $cm^{2}$ & HYP & Continuous \\
Degree of capsular penetration & cm & CAP & Continuous \\
Seminal Vesical Invasion & y/n & SEM & Categorical \\ 
Cleason Score & na & SCORE & Categorical \\ [1ex] % [1ex] adds vertical space
\hline %inserts single line
\end{tabular}
\label{table:model.variables}
\end{table}

\subsection{Statistical Analysis}

Describe the statistical model or models used

\subsubsection{Model Assumptions}

All inferences are conducted using $\alpha = 0.05$ unless stated otherwise.  No adjustments for multiplicity are made as this is an exploratory analysis. Discrete variables are summarized with proportions and frequencies.  Continuous variables are summarized using the following statistics:

\subsubsection{Primary Objective Analysis}

The primary objective analysis uses a Wilcoxon signed rank test to determine if there is a significant difference between cPRA scores at baseline and at week 16.  

\subsubsection{Secondary Objective Analyses}

Summary statistics are produced for baseline characteristics.  

\subsubsection{Goodness of Fit Test}

Describe here what goodness of fit statistics were used or will be used.

All of the statistical analyses in this document will be performed using `r R.version.string` [R](https://www.r-project.org/) \citep{r2018}.
R packages used will be maintained using the [packrat](http://rstudio.github.io/packrat/) dependency management system. 


```{r echo=FALSE, message=FALSE}
dataraw <- read_xlsx("../823data/pcancer.xlsx")

data2 <- data.frame(dataraw)
data2$seminal <- factor(dataraw$seminal)
levels(data2$seminal) <- c("absence", "presence")
data2$score <- factor(dataraw$score)
levels(data2$score) <- c("6", "7", "8")

attach(data2)
```
\section{Results}

Describe your results here. Add subheadings if necessary.

\subsection{summary of statistics}

```{r tab.summary, echo=FALSE, message=FALSE, results='asis'}
library(epiDisplay)
summ.table <- summ(data2[2:9])$table
summ.table[1:8] <- c("PSA","VOL","WT","AGE","HYP","SEM","CAP","SCORE")
colnames(summ.table) <- c("Variable","Obs. Count","Mean","Median","SD","Min.","Max.")
xtable(summ.table,label="tab:tab.summary",caption = "Summary of statistics")
```

\section{Analysis of Covariates}

```{r correlation, echo=FALSE, include=TRUE, message=FALSE, warning=TRUE, fig.cap="Correlation of available continuous covariates", fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}
library(psych)
library(GGally)
#pairs.panels(data2[c(2:6,8)])

ggpairs(data2[c(2:6,8)],ggplot2::aes())
```

Correlation coefficients in Figure \ref{fig:correlation} indicate the best relationships are between \textit{psa} and \textit{capsular} and between \textit{psa} and \textit{cancer volume} 

The correlation between \textit{weight}, \textit{hyperplasia} and \textit{age} are much weaker. 

```{r dist.cov.box, echo=FALSE, include=TRUE, fig.cap="Distribution of continuous variables",fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}
p1 <- ggplot(data2, aes(y=cancerv,x=1)) + 
  geom_boxplot() + 
  ggtitle("(a) Cancer Volume") + 
  labs(x="") + 
  geom_jitter(position=position_jitter(0.05)) + 
  theme(plot.title = element_text(color="blue", size=10, face="bold.italic"))

p2 <- ggplot(data2, aes(y=capsular,x=1)) + 
  geom_boxplot() + 
  ggtitle("(b) Capsular penetration") + 
  labs(x="") + 
  geom_jitter(position=position_jitter(0.05))

p3 <- ggplot(data2, aes(y=hyperplasia,x=1)) + 
  geom_boxplot() + 
  ggtitle("(c) Hyperplasia") + 
  labs(x="") + 
  geom_jitter(position=position_jitter(0.05))

p4 <- ggplot(data2, aes(y=weight,x=1)) + 
  geom_boxplot() + 
  ggtitle("(d) Weight") + 
  labs(x="") + 
  geom_jitter(position=position_jitter(0.05))

p5 <- ggplot(data2, aes(y=age,x=1)) + 
  geom_boxplot() + 
  ggtitle("(e) Age") + 
  labs(x="") + 
  geom_jitter(position=position_jitter(0.05))

grid.arrange(ncol = 2, p1,p2)
grid.arrange(ncol = 2, p3,p4)
grid.arrange(ncol = 2, p5)
```

Figure \ref{fig:dist.cov.box} plots the distribution for all continuous variables being considered as potential covariates.  The plots show the distribution is noticibly skewed in each case

```{r}

```

Figure \ref{fig:dist.cat} shows the distribution of the of Score and Seminal factors
```{r dist.cat, echo=FALSE, include=TRUE, fig.cap="distribution of factor variables",fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}
par(mfrow = c(1,2))
tab1(data2$seminal, main = "Distribution of Seminal")
tab1(data2$score, main="Distribution of Score")
```



```{r dist.cov.hist, echo=FALSE, message=FALSE, warning=TRUE, fig.cap="Histogram of cancerv, capsular and hyperplasia"}
#par(mfrow=c(2,2))
p1 <- ggplot(data2, aes(x=cancerv)) + 
  geom_histogram(binwidth = 2)

p2 <- ggplot(data2, aes(x=log(cancerv))) + 
  geom_histogram(binwidth = 1)

p3 <- ggplot(data2, aes(x=capsular)) + 
  geom_histogram(binwidth = 0.5)

grid.arrange(ncol = 2, p1,p2,p3)
```

Figure \ref{fig:dist.cov.hist} shows the skewness of the three potential covariates, indicating the data may not be normally distributed and problems with non constant variance may exist.  A log transformation improved the distribution of Cancer Volume. Capsular does not allow for a similar transformation because of the observations with a value of '0'


```{r, tab.stat.summary, echo=FALSE}
lm.cancerv <- lm(data = data2, psa ~ cancerv)
lm.cancerv.log <- lm(data = data2, log(psa) ~ log(cancerv))
lm.hyperplasia <- lm(data = data2, psa ~ hyperplasia)
lm.capsular <- lm(data = data2, psa ~ capsular)
lm.weight <- lm(data = data2, psa ~ weight)
lm.weight.log <- lm(data = data2, log(psa) ~ log(weight))
lm.age <- lm(data = data2, psa ~ age)
lm.score6 <- lm(data = data2, psa ~ (score==6))
lm.score7 <- lm(data = data2, psa ~ (score==7))
lm.score8 <- lm(data = data2, psa ~ (score==8))
lm.seminal <- lm(data = data2, psa ~ seminal)

summ.cancerv <- summary(lm.cancerv)
summ.hyperplasia <- summary(lm.hyperplasia)
summ.capsular <- summary(lm.capsular)
summ.weight <- summary(lm.weight)
summ.age <- summary(lm.age)
summ.score8 <- summary(lm.score8)
summ.seminal <- summary(lm.seminal)

summ.cancerv.v <- c(summ.cancerv$coefficients[c(2,4,6,8)],summ.cancerv$adj.r.squared,summ.cancerv$fstatistic[1])
summ.hyperplasia.v <- c(summ.hyperplasia$coefficients[c(2,4,6,8)],summ.hyperplasia$adj.r.squared,summ.hyperplasia$fstatistic[1])
summ.capsular.v <- c(summ.capsular$coefficients[c(2,4,6,8)],summ.capsular$adj.r.squared,summ.capsular$fstatistic[1])
summ.age.v <- c(summ.age$coefficients[c(2,4,6,8)],summ.age$adj.r.squared,summ.age$fstatistic[1])
summ.weight.v <- c(summ.weight$coefficients[c(2,4,6,8)],summ.weight$adj.r.squared,summ.weight$fstatistic[1])
summ.score8.v <- c(summ.score8$coefficients[c(2,4,6,8)],summ.score8$adj.r.squared,summ.score8$fstatistic[1])
summ.seminal.v <- c(summ.seminal$coefficients[c(2,4,6,8)],summ.seminal$adj.r.squared,summ.seminal$fstatistic[1])


summarydf <- data.frame("VOL"=summ.cancerv.v,
                        "HYP"=summ.hyperplasia.v,
                        "CAP"=summ.capsular.v,
                        "AGE"=summ.age.v,
                        "WT"=summ.weight.v,
                        "SCORE"=summ.score8.v,
                        "SEM"=summ.seminal.v)
rownames(summarydf) <- c("beta1","std Err","t-value","p-value","adj. R2","f-statistic")


for(i in 1:ncol(summarydf)){
  summarydf[[i]] <- sapply(summarydf[,i],function(x){if(x>0.0001){
                                                        return(format(x,digits=4))
                                                      }else{
                                                        return(format(x,digits=2))
                                                      }
                                                    })
}

knitr::kable(summarydf,label = "tab.stat.summary")
                        
```

\subsection{CAP}

```{r CAP.dist, echo=FALSE, fig.cap="Visualize CAP distribution", message=FALSE,fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}

par(mfrow=c(1,2))
plot(y=data2$psa,x=data2$capsular, 
     xlab="PSA", 
     ylab="CAP", 
     main="CAP Fit")
abline(lm.capsular)

plot(fitted(lm.capsular),residuals(lm.capsular), 
     xlab="residuals",
     ylab="fitted",
     main = "CAP fitted \n vs residuals")
abline(h = 0)
```

the fitted line in Figure \ref{fig:capsular.dist} indicates a poor linear relationship between PSA and Capsular.  The figure also shows indications the residuals will not support the non constant variance assumptions required for inference

\subsection{VOL}

```{r VOL.dist, echo=FALSE, fig.cap="Visualize VOL distribution", message=FALSE,fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}
par(mfrow=c(1,2))
plot(y=data2$psa,x=data2$cancerv, 
     xlab="PSA", 
     ylab="VOL", 
     main="VOL Fit")
abline(lm.cancerv)

plot(fitted(lm.cancerv),residuals(lm.cancerv), 
     xlab="residuals",
     ylab="fitted",
     main = "VOL fitted vs residuals")
abline(h = 0)

```

Figure \ref{fig:cancerv.dist} Shows very clear evidence of distribution problems.  The non constant variance test and shapiro-wilks test both indicate the data violates the assumption of constant variance and normal distribution

\subsection{WT}


```{r WT.dist, echo=FALSE, fig.cap="Visualize WT distribution", message=FALSE,fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}
par(mfrow=c(1,2))
plot(y=data2$psa,x=data2$weight, 
     xlab="PSA", 
     ylab="WT", 
     main="WT Regression Fit")
abline(lm.weight)

plot(fitted(lm.weight),residuals(lm.weight), 
     xlab="residuals",
     ylab="fitted",
     main = "WT fitted vs residuals")
abline(h = 0)

```

\subsection{AGE}

```{r AGE.dist, echo=FALSE, fig.cap="Visualize AGE distribution", message=FALSE,fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}
par(mfrow=c(1,2))
plot(y=data2$psa,x=data2$age, 
     xlab="PSA", 
     ylab="AGE", 
     main="AGE Regression Fit")
abline(lm.age)

plot(fitted(lm.age),residuals(lm.age), 
     xlab="residuals",
     ylab="fitted",
     main = "AGE fitted vs residuals")
abline(h = 0)

```

\subsection{HYP}

```{r, HYP.dist, echo=FALSE, fig.cap="Visualize AGE distribution", message=FALSE,fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}
par(mfrow=c(1,2))
plot(y=data2$psa,x=data2$age, 
     xlab="PSA", 
     ylab="HYP", 
     main="HYP Regression Fit")
abline(lm.age)

plot(fitted(lm.age),residuals(lm.age), 
     xlab="residuals",
     ylab="fitted",
     main = "HYP fitted vs residuals")
abline(h = 0)

```
\subsection{Transformations}

```{r echo=FALSE}
ncvp <-ncvTest(lm.cancerv)$p
swp <- shapiro.test(residuals(lm.cancerv))$p.value
```

The non-constant variance test and shapiro wilks test both indicate a problem with the distribution of the residuals.  The Shapiro-wilks p-value is `r swp` and the non-constant variance test p-value is `r ncvp` indicating the residuals are not normally distributed and the non-constant varaiance assumptions must be rejected. 

A log transformation of both psa and cancerv was found to generate a normal distribution of the residuals and also removed the problems with homoscedacity.

The regression plot and plot of the residuals vs. the fitted variables both indicate improvements in the distribution of the data

The p.values for shapiro wilks test and non-constant variance tests allow acceptance of the null hypothesis 

```{r log.cancerv.dist, echo=FALSE, include=TRUE, fig.cap="cancer volume distribution after a log log transformation",fig.pos="H", fig.align='center', out.width="0.6\\linewidth"}

par(mfrow=c(1,2))
plot(y=log(data2$psa),x=log(data2$cancerv), 
     xlab="log(PSA)", 
     ylab="log(Cancer Volume)", 
     main="Cancer Volume \n Regression Fit")

abline(lm.cancerv.log)

plot(fitted(lm.cancerv.log),residuals(lm.cancerv.log), 
     xlab="residuals",
     ylab="fitted",
     main = "Log(Cancer Vol.)\n fitted vs residuals")
abline(h = 0)
```

```{r tab4, results="asis",echo=FALSE, include=TRUE, message=TRUE}
ncvp <-ncvTest(lm.cancerv.log)$p
swp <- shapiro.test(residuals(lm.cancerv.log))$p.value
t<- data.frame(a=c(swp),b=c(ncvp))
knitr::kable(t,col.names =c("Shapiro-wilks p-value","ncv test p-value"),label="tab:tab4",caption = "Shapiro-wilks and ncv test")
```

\section{Covariate Selection}

Examination of the p-values and adjusted $R^{2}$ for the individual regression models indicated several potential covariates were not statistically significant and and did not show an acceptable linear relationship.  Based on the regression p-values and adjusted $R^{2}$, \textbf{HYP}, \textbf{AGE}, and \textbf{WT} were excluded from further consideration

The categorical variable \textbf{SCORE} did not have a significant p-value for values of 6 and 7, but score 8 was statistically. 

```{r tab.covariate.sel, echo=FALSE, results = 'asis'}
b <- regsubsets(log(psa) ~ log(cancerv)+seminal+capsular+score, data = data2)
regsub <- summary(b)
regsubdf <- data.frame(regsub$which)
regsubdf <- with(regsub, cbind(which, rss, adjr2, cp, bic))
colnames(regsubdf) <- c("Intercept","VOL","SEM (presence)","CAP","SCORE (7)","SCORE (8)","RSS","Adj R2","cp","bic")

kable(regsubdf, digits = 4, label = "tab.covariate.sel")



```

The output of automatic covariate selection in table \ref{tab.covariate.sel} agreed with the analysis of \textbf{SCORE}, indicating only a value of 8 was significant 

Based on the lowest BIC, cp and the highest $R^{2}$, the following 3 covariates were selected for the final model: 

\begin{itemize}
  \item \textbf{VOL}
  \item \textbf{SCORE for value=8}
  \item \textbf{SEM}
\end{itemize}

test for linearity and variance for each variable
\subsection{regression models}

```{r}
lm.multi <- lm(data=data2, log(psa) ~ log(cancerv) + score + seminal)
lm.multi.summary <- summary(lm.multi)

```


```{r echo=FALSE}
gi <- influence(lm.multi)
par(mfrow=c(1,2))

halfnorm(cooks.distance(lm.multi), cex = 1.5, las=1)
influencePlot(lm.multi, id = list(n = 3))
```


```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```


